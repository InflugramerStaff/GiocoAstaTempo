<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giocatore - Gioco d'Asta a Tempo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            text-align: center;
        }
        .header {
            background-color: #f8f8f8;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-info {
            padding: 15px;
            background-color: #f1f1f1;
        }
        .bid-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .bid-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: white;
            font-size: 24px;
            border: none;
            outline: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        .bid-button:active {
            transform: scale(0.95);
            background-color: #45a049;
        }
        .bid-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .bid-button.ready {
            background-color: #4CAF50;
        }
        .bid-button.confirming {
            background-color: #FFA500;
        }
        .wait-message {
            font-size: 20px;
            margin-top: 20px;
            color: #666;
        }
        .bidding-timer {
            font-size: 36px;
            margin-top: 20px;
            font-weight: bold;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-top: 1px solid #ddd;
        }
        .eliminated {
            background-color: #ffcccc;
        }
        .winner-highlight {
            color: green;
            font-weight: bold;
        }
        .leave-button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .leave-button:hover {
            background-color: #d32f2f;
        }
        .countdown {
            font-size: 24px;
            margin-top: 10px;
            color: #FFA500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>Round: <span id="current-round">0</span>/19</h2>
        <div>Gettoni: <span id="tokens-count">0</span></div>
        <button id="leave-game-btn" class="leave-button">Abbandona</button>
    </div>

    <div class="player-info">
        <h2 id="player-name">Nome Giocatore</h2>
        <div id="game-status">In attesa dell'inizio della partita...</div>
    </div>

    <div class="bid-area">
        <button id="bid-button" class="bid-button" disabled>TIENI PREMUTO PER OFFRIRE</button>
        <div id="bidding-timer" class="bidding-timer" style="display: none;">0.000s</div>
        <div id="wait-message" class="wait-message">In attesa dell'inizio del round...</div>
    </div>

    <div id="confirmation-countdown" class="countdown" style="display: none;">5</div>

    <div class="results">
        <h3>Risultati Round <span id="result-round-number">0</span></h3>
        <div id="round-result">
            <!-- I risultati saranno aggiunti qui dinamicamente -->
            Nessun risultato disponibile.
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Inserisci qui la configurazione di Firebase che hai copiato
        const firebaseConfig = {
             apiKey: "AIzaSyD3kaXir_Hs53Cq4wID7Uz0z5fQxKYJutI",
  authDomain: "giocoastatempo.firebaseapp.com",
  databaseURL: "https://giocoastatempo-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "giocoastatempo",
  storageBucket: "giocoastatempo.firebasestorage.app",
  messagingSenderId: "1035401437404",
  appId: "1:1035401437404:web:b315574b573fb1997a5419"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Verificare che siamo autorizzati come giocatore
        if (localStorage.getItem('playerType') !== 'player') {
            alert('Accesso non autorizzato all\'interfaccia giocatore.');
            window.location.href = 'index.html';
        }

        const gameId = localStorage.getItem('gameId');
        const playerId = localStorage.getItem('playerId');
        const playerName = localStorage.getItem('playerName');

        if (!gameId || !playerId) {
            alert('Informazioni di gioco mancanti. Torna alla home.');
            window.location.href = 'index.html';
        }

        // Riferimento alla partita e al giocatore nel database
        const gameRef = database.ref('games/' + gameId);
        const playerRef = database.ref('games/' + gameId + '/players/' + playerId);

        // Imposta il nome del giocatore nell'interfaccia
        document.getElementById('player-name').textContent = playerName;

        // Variabili per la gestione delle offerte
        let bidStartTime = 0;
        let bidTimer = null;
        let isBidding = false;
        let playerData = null;
        let gameData = null;
        let confirmationTimer = null;
let confirmationTime = 5; // 5 secondi per confermare
let confirmationCountdown = confirmationTime;
let isConfirming = false;
let isConfirmed = false;
let actualBidStartTime = 0;

        // --- 3. Verifica della connessione Firebase (all'inizio della sezione <script>) ---
const connectedRef = database.ref(".info/connected");
connectedRef.on("value", (snap) => {
    if (snap.val() === true) {
        console.log("Connesso al database Firebase");
    } else {
        console.log("Disconnesso dal database Firebase");
        alert("Connessione al server persa. Ricaricare la pagina.");
    }
});

        // Ascolta le modifiche alla partita
        gameRef.on('value', snapshot => {
            const game = snapshot.val();
            
            if (!game) {
                alert('Partita non trovata o terminata.');
                window.location.href = 'index.html';
                return;
            }

            gameData = game;

            // Aggiorna le informazioni di base
            document.getElementById('current-round').textContent = game.currentRound;
            
            // Controlla lo stato del gioco
            updateGameStatus(game);

            // Aggiorna i dati del giocatore se disponibili
            if (game.players && game.players[playerId]) {
                playerData = game.players[playerId];
                
                // Aggiorna contatore gettoni
                document.getElementById('tokens-count').textContent = playerData.tokens;
                
                // Se il giocatore √® eliminato, disabilita il pulsante e mostra un messaggio
                if (playerData.isEliminated) {
                    document.getElementById('bid-button').disabled = true;
                    document.getElementById('wait-message').textContent = 'Sei stato eliminato dalla partita.';
                    document.body.classList.add('eliminated');
                }
            }

            // Aggiorna i risultati se disponibili
            updateRoundResults(game);
        });

        // Gestione del pulsante di offerta
        const bidButton = document.getElementById('bid-button');
        const biddingTimer = document.getElementById('bidding-timer');
        const waitMessage = document.getElementById('wait-message');

        // Touch/Mousedown - Inizia la conferma e poi l'offerta
        bidButton.addEventListener('pointerdown', function(e) {
            if (!gameData || !playerData || playerData.isEliminated || bidButton.disabled) {
                return;
            }

            // Previeni comportamenti indesiderati su mobile
            e.preventDefault();

            // Se non stiamo gi√† confermando, inizia la fase di conferma
            if (!isConfirming && !isConfirmed) {
                isConfirming = true;
                confirmationCountdown = confirmationTime;

                // Cambia l'aspetto del pulsante durante la conferma
                bidButton.classList.add('confirming');
                bidButton.textContent = 'TIENI PREMUTO PER CONFERMARE...';

                // Mostra il countdown
                const countdownElement = document.getElementById('confirmation-countdown');
                countdownElement.style.display = 'block';
                countdownElement.textContent = confirmationCountdown;

                // Avvia il timer di conferma
                confirmationTimer = setInterval(function() {
                    confirmationCountdown--;
                    countdownElement.textContent = confirmationCountdown;

                    // Quando il countdown arriva a 0, passiamo alla fase di offerta
                    if (confirmationCountdown <= 0) {
                        clearInterval(confirmationTimer);
                        isConfirming = false;
                        isConfirmed = true;

                        // Nascondi il countdown
                        countdownElement.style.display = 'none';

                        // Cambia l'aspetto del pulsante per l'offerta
                        bidButton.classList.remove('confirming');
                        bidButton.classList.add('ready');
                        bidButton.textContent = 'STAI OFFRENDO...';

                        // Notifica al database che il giocatore sta offrendo
                        gameRef.child(`rounds/${gameData.currentRound}/bidding/${playerId}`).set(true);

                        // Inizia a misurare il tempo effettivo di offerta
                        actualBidStartTime = Date.now();

                        // Mostra il timer di offerta
                        biddingTimer.style.display = 'block';
                        waitMessage.style.display = 'none';

                        // Aggiorna il timer visivamente
                        bidTimer = setInterval(function() {
                            const elapsedSeconds = (Date.now() - actualBidStartTime) / 1000;
                            biddingTimer.textContent = elapsedSeconds.toFixed(3) + 's';

                            // Se il tempo supera quello disponibile, ferma l'offerta
                            if (elapsedSeconds >= playerData.remainingTime) {
                                stopBidding();
                            }
                        }, 10); // Aggiorna ogni 10ms per maggiore precisione
                    }
                }, 1000);
            }
        });

        // Touch/Mouseup - Termina l'offerta o annulla la conferma
        bidButton.addEventListener('pointerup', function(e) {
            if (isConfirming) {
                // Se il giocatore rilascia durante la fase di conferma, annulla tutto
                clearInterval(confirmationTimer);
                isConfirming = false;

                // Ripristina l'aspetto del pulsante
                bidButton.classList.remove('confirming');
                bidButton.textContent = 'TIENI PREMUTO PER PARTECIPARE';

                // Nascondi il countdown
                document.getElementById('confirmation-countdown').style.display = 'none';

                // Notifica che il giocatore non partecipa a questo round
                gameRef.child(`rounds/${gameData.currentRound}/participating/${playerId}`).set(false);

                // Mostra messaggio di non partecipazione
                waitMessage.style.display = 'block';
                waitMessage.textContent = 'Hai scelto di non partecipare a questo round. In attesa del prossimo...';

                // Blocca il pulsante per questo round
                bidButton.disabled = true;
            } else if (isConfirmed) {
                // Se ha completato la conferma ed √® in fase di offerta, procedi con stopBidding
                stopBidding();
            }
        });

        // Modifica la funzione stopBidding per gestire la nuova logica
        function stopBidding() {
            if (!isConfirmed) return;

    isConfirmed = false;
    clearInterval(bidTimer);

    // Calcola il tempo offerto in secondi (solo il tempo dopo la conferma)
    const endTime = Date.now();
    const bidTime = (endTime - actualBidStartTime) / 1000;

    // Blocca l'input fino al prossimo round
    bidButton.disabled = true;
    bidButton.classList.remove('ready');

    // Assicurati che il tempo offerto non superi il tempo residuo
    const actualBidTime = Math.min(bidTime, playerData.remainingTime);

    // Nascondi il timer e mostra il messaggio di attesa
    biddingTimer.style.display = 'none';
    waitMessage.style.display = 'block';
    waitMessage.textContent = `Hai offerto ${actualBidTime.toFixed(3)} secondi. In attesa degli altri giocatori...`;

    // Notifica al database che il giocatore ha finito di offrire
    gameRef.child(`rounds/${gameData.currentRound}/bidding/${playerId}`).set(false);

    // Converti in millisecondi per una maggiore precisione
    const bidTimeMs = actualBidTime * 1000;
    const remainingTimeMs = playerData.remainingTime * 1000 - bidTimeMs;
    const newRemainingTime = Math.max(0, remainingTimeMs / 1000);

    // Aggiorna il database con l'offerta e il tempo residuo
    const currentRound = gameData.currentRound;
    const updates = {};

    // Registra l'offerta
    updates[`rounds/${currentRound}/bids/${playerId}`] = actualBidTime;

    // Aggiorna il tempo residuo e lo stato del giocatore
    updates[`players/${playerId}/remainingTime`] = newRemainingTime;
    updates[`players/${playerId}/isReady`] = true;

    // Se il giocatore ha esaurito il tempo, segnalo come eliminato
    if (newRemainingTime <= 0) {
        updates[`players/${playerId}/isEliminated`] = true;
    }

    // Esegui l'aggiornamento al database
    gameRef.update(updates).then(() => {
        // Verifica se questo √® l'ultimo giocatore a rilasciare il pulsante
        checkLastBidder();
    }).catch(error => {
        console.error('Errore durante l\'aggiornamento dell\'offerta:', error);
        waitMessage.textContent = 'Errore durante l\'invio dell\'offerta. Riprova.';
        bidButton.disabled = false;
    });
}

// Aggiungi una funzione per verificare se questo √® l'ultimo giocatore a rilasciare
function checkLastBidder() {
    gameRef.child(`rounds/${gameData.currentRound}/bidding`).once('value').then(snapshot => {
        const biddingPlayers = snapshot.val();

        // Se non ci sono pi√π giocatori che stanno offrendo, questo √® l'ultimo
        let stillBidding = false;
        if (biddingPlayers) {
            Object.keys(biddingPlayers).forEach(pid => {
                if (biddingPlayers[pid] === true) {
                    stillBidding = true;
                }
            });
        }

        // Se questo √® l'ultimo giocatore a rilasciare, segnalalo come vincitore
        if (!stillBidding) {
            gameRef.child(`rounds/${gameData.currentRound}`).update({
                lastBidder: playerId
            });
        }
    });
}

        // Controlla se tutti i giocatori hanno fatto la loro offerta
        function checkAllPlayersReady() {
            gameRef.once('value').then(snapshot => {
                const game = snapshot.val();
                
                if (!game || game.gameStatus !== 'bidding') {
                    return;
                }
                
                // Controlla se tutti i giocatori non eliminati sono pronti
                let allReady = true;
                let activePlayers = 0;
                
                Object.values(game.players).forEach(player => {
                    if (!player.isEliminated) {
                        activePlayers++;
                        if (!player.isReady) {
                            allReady = false;
                        }
                    }
                });
                
                // Se tutti sono pronti, determina il vincitore del round
                if (allReady && activePlayers > 0) {
                    determineRoundWinner(game);
                }
            });
        }

        // Questa funzione non √® pi√π necessaria poich√© usiamo il lastBidder
// La manteniamo solo come fallback in caso non ci sia un lastBidder definito
function determineRoundWinner(game) {
    const currentRound = game.currentRound;
    const roundData = game.rounds[currentRound];

    // Se c'√® gi√† un lastBidder, non facciamo nulla (la logica √® gestita dal tabellone)
    if (roundData && roundData.lastBidder) {
        return;
    }

    // Fallback: vecchia logica solo se non c'√® lastBidder
    if (!roundData || !roundData.bids || Object.keys(roundData.bids).length === 0) {
        return;
    }

    // Trova l'offerta pi√π alta
    let highestBid = -1;
    let highestBidders = [];

    Object.keys(roundData.bids).forEach(pid => {
        const bid = roundData.bids[pid];
        if (bid > highestBid) {
            highestBid = bid;
            highestBidders = [pid];
        } else if (bid === highestBid) {
            highestBidders.push(pid);
        }
    });

    // Crea l'oggetto con gli aggiornamenti
    const updates = {
        [`rounds/${currentRound}/status`]: 'completed',
        gameStatus: 'results'
    };

    // Se c'√® un solo vincitore, assegna il gettone
    if (highestBidders.length === 1) {
        const winnerId = highestBidders[0];
        updates[`rounds/${currentRound}/winner`] = winnerId;
        updates[`rounds/${currentRound}/isTie`] = false;

        // Incrementa il contatore dei gettoni del vincitore
        const currentTokens = game.players[winnerId].tokens || 0;
        updates[`players/${winnerId}/tokens`] = currentTokens + 1;
    } else {
        // Pareggio, nessun vincitore
        updates[`rounds/${currentRound}/winner`] = null;
        updates[`rounds/${currentRound}/isTie`] = true;
    }

    // Aggiorna il database
    gameRef.update(updates);
}

        // --- C. Ascoltatore specifico per i cambiamenti di stato del gioco ---
const gameStatusRef = database.ref('games/' + gameId + '/gameStatus');
gameStatusRef.on('value', snapshot => {
    const status = snapshot.val();
    if (status === 'bidding') {
        gameRef.once('value').then(gameSnapshot => {
            const gameData = gameSnapshot.val();
            updateGameStatus(gameData);
        });
    }
});

        // Aggiorna lo stato del gioco nella UI
        function updateGameStatus(game) {
            const statusElement = document.getElementById('game-status');
            const waitMessageElement = document.getElementById('wait-message');
            const bidButton = document.getElementById('bid-button');
            
            switch(game.gameStatus) {
                case 'waiting':
                    statusElement.textContent = 'In attesa dell\'inizio della partita...';
                    waitMessageElement.textContent = 'In attesa che l\'host avvii la partita...';
                    bidButton.disabled = true;
                    break;
                    
                case 'running':
                    statusElement.textContent = 'In attesa dell\'inizio del round...';
                    waitMessageElement.textContent = 'In attesa dell\'inizio del round...';
                    bidButton.disabled = true;
                    break;
                    
                case 'bidding':
                    // Controllare se il giocatore ha gi√† partecipato a questo round
                    if (game.rounds &&
                        game.rounds[game.currentRound] &&
                        game.rounds[game.currentRound].participating &&
                        game.rounds[game.currentRound].participating[playerId] === false) {
                        statusElement.textContent = 'Round in corso...';
                        waitMessageElement.textContent = 'Hai scelto di non partecipare a questo round. In attesa del prossimo...';
                        bidButton.disabled = true;
                    }
                    // Controllare se il giocatore √® gi√† pronto (ha gi√† fatto un'offerta)
                    else if (playerData && playerData.isReady) {
                        statusElement.textContent = 'Round in corso...';
                        waitMessageElement.textContent = 'In attesa degli altri giocatori...';
                        bidButton.disabled = true;
                    }
                    // Controllare se il giocatore sta gi√† offrendo
                    else if (game.rounds &&
                             game.rounds[game.currentRound] &&
                             game.rounds[game.currentRound].bidding &&
                             game.rounds[game.currentRound].bidding[playerId]) {
                        statusElement.textContent = 'Stai offrendo!';
                        waitMessageElement.style.display = 'none';
                        bidButton.disabled = false;
                    }
                    // Altrimenti il giocatore pu√≤ partecipare
                    else if (!playerData.isEliminated) {
                        statusElement.textContent = '√à il tuo turno di partecipare!';
                        waitMessageElement.textContent = 'Tieni premuto il pulsante per 5 secondi per partecipare...';
                        bidButton.textContent = 'TIENI PREMUTO PER PARTECIPARE';
                        bidButton.disabled = false;

                        // Resetta gli stati di conferma e offerta
                        isConfirming = false;
                        isConfirmed = false;
                        if (confirmationTimer) clearInterval(confirmationTimer);
                        if (bidTimer) clearInterval(bidTimer);

                        // Rimuovi eventuali classi dal pulsante
                        bidButton.classList.remove('confirming', 'ready');

                        // Nascondi elementi di conteggio
                        document.getElementById('confirmation-countdown').style.display = 'none';
                        biddingTimer.style.display = 'none';
                    } else {
                        statusElement.textContent = 'Round in corso...';
                        waitMessageElement.textContent = 'Sei stato eliminato dalla partita.';
                        bidButton.disabled = true;
                    }
                    break;
                    
                case 'results':
                    statusElement.textContent = 'Risultati del round ' + game.currentRound;
                    waitMessageElement.textContent = 'In attesa del prossimo round...';
                    bidButton.disabled = true;
                    break;
                    
                case 'completed':
                    statusElement.textContent = 'Partita terminata!';
                    
                    // Mostra il vincitore
                    if (game.winner) {
                        const winnerName = game.players[game.winner].name;
                        waitMessageElement.textContent = 'Il vincitore √® ' + winnerName + '!';
                        
                        // Evidenzia se il giocatore corrente √® il vincitore
                        if (game.winner === playerId) {
                            waitMessageElement.classList.add('winner-highlight');
                            waitMessageElement.textContent += ' Congratulazioni!';
                        }
                    } else {
                        waitMessageElement.textContent = 'Partita terminata in pareggio!';
                    }
                    
                    bidButton.disabled = true;
                    break;
            }
        }

        // Aggiorna i risultati del round
        function updateRoundResults(game) {
            if (!game.rounds || game.currentRound === 0) {
                return;
            }
            
            const currentRound = game.currentRound;
            const roundData = game.rounds[currentRound];
            
            if (!roundData || roundData.status !== 'completed') {
                return;
            }
            
            // Aggiorna il numero del round nei risultati
            document.getElementById('result-round-number').textContent = currentRound;
            
            // Elemento dove mostrare i risultati
            const resultElement = document.getElementById('round-result');
            resultElement.innerHTML = '';
            
            // Se non ci sono offerte
            if (!roundData.bids || Object.keys(roundData.bids).length === 0) {
                resultElement.textContent = 'Nessuna offerta in questo round.';
                return;
            }
            
            // Crea un array di offerte per ordinarle
            const bidsArray = [];
            
            Object.keys(roundData.bids).forEach(pid => {
                if (game.players[pid]) {
                    bidsArray.push({
                        playerId: pid,
                        playerName: game.players[pid].name,
                        bidTime: roundData.bids[pid],
                        isWinner: roundData.winner === pid,
                        isCurrentPlayer: pid === playerId
                    });
                }
            });
            
            // Ordina per tempo offerto (discendente)
            bidsArray.sort((a, b) => b.bidTime - a.bidTime);
            
            // Crea gli elementi HTML per i risultati
            const resultsList = document.createElement('ul');
            resultsList.style.listStyle = 'none';
            resultsList.style.padding = '0';
            
            bidsArray.forEach(bid => {
                const listItem = document.createElement('li');
                listItem.style.padding = '5px 0';
                
                // Formatta il tempo offerto
                const bidTimeFormatted = bid.bidTime.toFixed(3) + 's';
                
                // Crea il testo del risultato
                let resultText = `${bid.playerName}: ${bidTimeFormatted}`;
                
                // Evidenzia se √® il vincitore
                if (bid.isWinner) {
                    resultText += ' üèÜ VINCITORE!';
                    listItem.style.fontWeight = 'bold';
                    listItem.style.color = 'green';
                }
                
                // Evidenzia se √® il giocatore corrente
                if (bid.isCurrentPlayer) {
                    listItem.style.backgroundColor = '#f0f0f0';
                    resultText += ' (tu)';
                }
                
                listItem.textContent = resultText;
                resultsList.appendChild(listItem);
            });
            
            // Se c'√® stato un pareggio
            if (roundData.isTie) {
                const tieItem = document.createElement('li');
                tieItem.textContent = 'PAREGGIO - Nessun gettone assegnato';
                tieItem.style.textAlign = 'center';
                tieItem.style.fontWeight = 'bold';
                tieItem.style.color = 'red';
                tieItem.style.marginTop = '10px';
                resultsList.appendChild(tieItem);
            }
            
            resultElement.appendChild(resultsList);
        }

        // Gestione degli eventi quando la pagina si chiude
        window.addEventListener('beforeunload', function() {
            // Ferma qualsiasi offerta in corso
            if (isBidding) {
                stopBidding();
            }
        });

        // Gestione del pulsante "Abbandona"
        document.getElementById('leave-game-btn').addEventListener('click', function() {
            if (isBidding) {
                // Se il giocatore sta facendo un'offerta, fermala
                stopBidding();
            }
            
            // Chiedi conferma
            if (confirm('Sei sicuro di voler abbandonare la partita?')) {
                // Rimuovi il giocatore dalla partita se questa √® in attesa
                gameRef.once('value').then(snapshot => {
                    const game = snapshot.val();
                    
                    // Se la partita √® ancora in attesa, rimuovi il giocatore
                    if (game && game.gameStatus === 'waiting') {
                        gameRef.child('players/' + playerId).remove()
                            .then(() => {
                                console.log('Giocatore rimosso dalla partita');
                            })
                            .catch(error => {
                                console.error('Errore durante la rimozione del giocatore:', error);
                            });
                    } else if (game && (game.gameStatus === 'running' || game.gameStatus === 'bidding' || game.gameStatus === 'results')) {
                        // Se la partita √® in corso, segna il giocatore come eliminato
                        gameRef.child('players/' + playerId).update({
                            isEliminated: true,
                            remainingTime: 0
                        }).then(() => {
                            console.log('Giocatore segnato come eliminato');
                        }).catch(error => {
                            console.error('Errore durante l\'aggiornamento dello stato del giocatore:', error);
                        });
                    }
                    
                    // Pulisci i dati dal localStorage
                    localStorage.removeItem('gameId');
                    localStorage.removeItem('playerId');
                    localStorage.removeItem('playerName');
                    localStorage.removeItem('playerType');
                    
                    // Reindirizza alla pagina iniziale
                    window.location.href = 'index.html';
                }).catch(error => {
                    console.error('Errore durante la verifica dello stato della partita:', error);
                    // In caso di errore, reindirizza comunque
                    window.location.href = 'index.html';
                });
            }
        });
    </script>
</body>
</html>